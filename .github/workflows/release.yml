name: Build and Release Copy App

on:
  push:
    branches: [main]
    tags: ["v*.*.*"] # Triggers when you push a tag like v1.0.0

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"

      - name: Decode Keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > release.jks

      - name: Grant Execute Permission
        run: chmod +x gradlew

      - name: Build Signed APK
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # Extract numbers only for math: v0.0.9 -> 0.0.9
            CLEAN_VER=$(echo "${{ github.ref_name }}" | sed 's/[^0-9.]//g')
            VERSION_NAME="$CLEAN_VER"
          else
            # Default for branch pushes (e.g., main)
            CLEAN_VER="1.0.0"
            VERSION_NAME="$CLEAN_VER-dev"
          fi

          # Logic: 1.0.0 becomes 10000, 0.0.9 becomes 9
          # This ensures versionCode is always a valid integer
          VERSION_CODE=$(echo "$CLEAN_VER" | awk -F. '{printf "%d%02d%02d", $1, $2, $3}')

          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$GITHUB_WORKSPACE/release.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }} \
            -PversionName="$VERSION_NAME" \
            -PversionCode="$VERSION_CODE"

      - name: Prepare Versioned APK
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          cp app/build/outputs/apk/release/app-release.apk app/build/outputs/apk/release/copy-${{ github.ref_name }}.apk

      - name: Upload Artifact
        # Trigger for valid tags
        if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v') && contains(github.ref_name, '.')
        uses: actions/upload-artifact@v6
        with:
          name: copy-${{ github.ref_name }}
          path: app/build/outputs/apk/release/copy-${{ github.ref_name }}.apk

      - name: Create GitHub Release
        # Trigger for valid tags
        if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v') && contains(github.ref_name, '.')
        uses: softprops/action-gh-release@v2
        with:
          files: app/build/outputs/apk/release/copy-${{ github.ref_name }}.apk
          tag_name: ${{ github.ref_name }}
          name: Copy ${{ github.ref_name }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
